<!DOCTYPE html>
<style>
  .arjs-loader {
    height: 100%;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .arjs-loader div {
    text-align: center;
    font-size: 1.25em;
    color: white;
  }
</style>

    <!-- Scripts descargados desde la CDN -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

<html>
    <head>

        <meta charset="UTF-8">
        <title>Prueba webapp AR</title>
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    </head>

    <body style="margin: 0; overflow: hidden">

        <script type="text/javascript">
  (function(l) {
    if (l.search[1] === '/' ) {
      var decoded = l.search.slice(1).split('&').map(function(s) { 
        return s.replace(/~and~/g, '&')
      }).join('?');
      window.history.replaceState(null, null,
          l.pathname.slice(0, -1) + decoded + l.hash
      );
    }
  }(window.location))
</script>
        
        <div id="arjs-loader" class="arjs-loader">
            <div>Inicializando...</div>
        </div>

        <script>
            document.getElementById("arjs-loader").innerHTML = `<div>Prueba de cambio de texto</div>`;

            //Establecer conexion con API
AFRAME.registerComponent('conexion_db', {
    schema: {
        url: {type: 'string', default: ''}, //URL, que en el caso para hacer pruebas en local usaremos la del NAS
        interval: {type: 'number', default: 5000} //Cada cuantos ms se hace una llamada
    },

    //Conecta a la base de datos cuando cargue la página
    init: function() {
        console.log("Intentando realizar conexión con la DB.");
        document.getElementById("arjs-loader").innerHTML = `<div>Conectando con DB...</div>`;

        if (!this.data.url){
            document.getElementById("arjs-loader").innerHTML = `<div>No se ha encontrado la base de datos :(</div>`;
            alert("ERROR: No se ha establecido ninguna URL con la que conectar.");
            return;
        }

        this.syncData(); //Primera sincronización en cuanto conecta con la DB

        //Cronómetro para ver cada cuanto realiza la llamada
        this.timer = setInterval(() => {
            this.syncData();
        }, this.data.interval);
    },

    //Sincroniza los datos con el objeto indicado
    syncData: function() {
        fetch(this.data.url).then(response => {
            //Si no hay respuesta, indica que hubo un fallo de conexión
            if(!response.ok){ 
                alert("Ha habido un error de conexión");
                throw new Error("Error de conexión. Comprueba el estado de red.");
            }
            document.getElementById("arjs-loader").innerHTML = `<div>Conexión establecida. Cargando app...</div>`;
            return response.json();
        }).then(data => {
            //Establecemos el color
            if(data.color) {
                this.el.setAttribute('material', 'color', data.color);
            }

            //Establecemos el tamaño (a partir de una escala)
            if(data.size){
                let sz = parseFloat(data.size); //Por si acaso se pasara como string
                this.el.setAttribute('scale', {x: sz, y: sz, z: sz});
            }
        }).catch(error => {
            document.getElementById("arjs-loader").innerHTML = `<div>Error conectando con la API :(</div>`;
            alert(`Error de conexión con la API: ${error.message}`);
        });
    },

    //Reinicio de cronómetro en caso de implementarlo como app
    remove: function(){
        if (this.timer) clearInterval(this.timer);
    }
});

        </script>

        <a-scene
            vr-mode-ui="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            embedded arjs="trackingMethod: best; sourceType: webcam;debugUIEnabled: false;">
            <!-- Se encapsula el contenido que se mostrará en un QR bajo un "NFT" -->
            <a-nft
                type="nft"
                url="markers/qr codev prueba arjs"
                smooth="true"
                smoothCount="10"
                smoothTolerance=".01"
                smoothThreshold="5"
                >

                <a-box
                    position="0 0.5 0"
                    material="color: red;"
                    conexion_db="url: conexiones/config.php; interval: 1000">
                </a-box>
            
                <a-text
                    value="Prueba OK :3c"
                    position="2 0.5 0"
                    color="black"
                    scale="0.5 0.5 0.5">
                </a-text>

            </a-nft>

            <!-- Se crea la cámara para la escena -->
             <a-entity camera></a-entity>

        </a-scene>

        <script>
          window.addEventListener('arjs-nft-loaded', function () {
            var loader = document.querySelector(".arjs-loader");
            if (loader) {
              loader.style.display = "none";
            }
          });
        </script>

    </body>
</html>